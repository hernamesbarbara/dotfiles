#!/usr/bin/env zsh

github () {
  local target="${1:-.}"

  if ! command -v git >/dev/null 2>&1; then
    echo "git is not installed."
    return 1
  fi

  local repo_root
  repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || {
    echo "Not a git repository."
    return 1
  }

  local giturl
  giturl="$(git config --get remote.origin.url)"
  if [[ -z "$giturl" ]]; then
    echo "No remote.origin.url set."
    return 1
  fi

  # Normalize remote URL â†’ https://github.com/OWNER/REPO
  local base_url="$giturl"
  if [[ "$base_url" == git@github.com:* ]]; then
    base_url="${base_url/git@github.com:/https://github.com/}"
    base_url="${base_url%.git}"
  elif [[ "$base_url" == https://github.com/* ]]; then
    base_url="${base_url%.git}"
  elif [[ "$base_url" == git@gist.github.com:* ]]; then
    local gistid
    gistid="$(echo "$base_url" | sed 's/.*://;s/.git//')"
    base_url="https://gist.github.com/$gistid"
  fi

  # Prefer upstream branch; fall back to current branch
  local branch
  branch="$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null | sed 's|^[^/]*/||')" \
    || branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null)"
  [[ -z "$branch" ]] && branch="HEAD"

  # Support file:LINE or file:START-END
  local path_part="$target"
  local line_fragment=""
  if [[ "$target" == *:* ]]; then
    local after_colon="${target##*:}"
    local before_colon="${target%:*}"
    if [[ "$after_colon" == <-> ]]; then
      path_part="$before_colon"
      line_fragment="#L$after_colon"
    elif [[ "$after_colon" == <->-<-> ]]; then
      path_part="$before_colon"
      line_fragment="#L${after_colon%-*}-L${after_colon#*-}"
    fi
  fi

  # Resolve absolute path if it exists
  local abs_path
  if [[ -e "$path_part" ]]; then
    abs_path="$(cd -P -- "$(dirname -- "$path_part")" 2>/dev/null && pwd -P)/$(basename -- "$path_part")"
  else
    abs_path="$repo_root/$path_part"
  fi

  # Make repo-relative
  local rel_path="${abs_path#$repo_root/}"
  [[ "$abs_path" == "$repo_root" ]] && rel_path=""

  # Build final URL
  local url
  if [[ -z "$rel_path" ]]; then
    url="$base_url"
  elif [[ -d "$abs_path" ]]; then
    url="$base_url/tree/$branch/$rel_path"
  else
    url="$base_url/blob/$branch/$rel_path$line_fragment"
  fi

  echo "$url"
  command open "$url"
}
