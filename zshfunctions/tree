#!/usr/bin/env zsh
#
# tree wrapper with sensible defaults
#
# Defaults:
#   -F              trailing slash for directories
#   --gitignore     respect .gitignore rules
#   -I <pattern>    exclude .git and .DS_Store
#
# Override flags (these are stripped before calling tree):
#   --raw           bypass wrapper entirely, call tree directly
#   --no-gitignore  don't auto-add --gitignore
#   --no-ignore     don't auto-add default ignore patterns (keeps user's -I if provided)
#   --no-defaults   equivalent to --no-gitignore --no-ignore
#
# User's -I patterns are merged with defaults, not replaced.
# Example: tree -I 'foo' â†’ tree -F --gitignore -I '.git|.DS_Store|foo'
#
tree() {
  local -a args=()
  local -a user_ignores=()
  local raw=0 no_gitignore=0 no_ignore=0 has_gitignore=0

  # Default ignore patterns (pipe-separated for tree's -I)
  local default_ignore='.git|.DS_Store'

  local i=1
  while (( i <= $# )); do
    local arg="${@[$i]}"
    case "$arg" in
      --raw)
        raw=1
        ;;
      --no-gitignore)
        no_gitignore=1
        ;;
      --no-ignore)
        no_ignore=1
        ;;
      --no-defaults)
        no_gitignore=1
        no_ignore=1
        ;;
      --gitignore)
        has_gitignore=1
        args+=("$arg")
        ;;
      --)
        # Stop option parsing; pass through the rest verbatim
        (( i++ ))
        while (( i <= $# )); do
          args+=("${@[$i]}")
          (( i++ ))
        done
        break
        ;;
      -I)
        (( i++ ))
        [[ $i -le $# ]] && user_ignores+=("${@[$i]}")
        ;;
      -I*)
        user_ignores+=("${arg#-I}")
        ;;
      --ignore=*)
        # Wrapper convenience: treat like -I
        user_ignores+=("${arg#--ignore=}")
        ;;
      *)
        args+=("$arg")
        ;;
    esac
    (( i++ ))
  done

  # Full escape hatch (strip wrapper-only flags)
  if (( raw )); then
    command tree "${args[@]}"
    return
  fi

  # Merge ignore patterns:
  # - If --no-ignore: don't add defaults, but keep user patterns.
  local final_ignore=""
  if (( ! no_ignore )); then
    final_ignore="$default_ignore"
  fi

  for pat in "${user_ignores[@]}"; do
    if [[ -n "$final_ignore" ]]; then
      final_ignore="${final_ignore}|${pat}"
    else
      final_ignore="$pat"
    fi
  done

  local -a cmd=(command tree -F)

  if (( ! no_gitignore && ! has_gitignore )); then
    cmd+=(--gitignore)
  fi

  if [[ -n "$final_ignore" ]]; then
    cmd+=(-I "$final_ignore")
  fi

  cmd+=("${args[@]}")
  "${cmd[@]}"
}
